name: Dynamic Portal Update

on:
  schedule:
    - cron: '0 22 * * *'   # 05.00 WIB setiap hari
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Install jq
        run: sudo apt-get install jq

      - name: Update Renungan (Harian + Arsip)
        run: |
          TODAY=$(date +"%d %B %Y")
          ID=$(date +%s)

          NEW_ITEM=$(jq -n \
            --arg id "$ID" \
            --arg t "$TODAY" \
            --arg j "Renungan $TODAY" \
            --arg i "Iman bertumbuh melalui konsistensi.\n\nPertumbuhan terjadi melalui disiplin rohani yang dilakukan setiap hari.\n\nKeputusan kecil yang setia membentuk masa depan yang kuat." \
            '{id:$id, tanggal:$t, judul:$j, isi:$i}')

          if [ -f data/renungan.json ]; then
            jq ". |= [$NEW_ITEM] + . | .[:30]" data/renungan.json > temp.json
          else
            echo "[$NEW_ITEM]" > temp.json
          fi

          mv temp.json data/renungan.json

      - name: Update Kesaksian (Setiap Senin + Arsip)
        run: |
          DAY=$(date +%u)
          if [ "$DAY" -eq 1 ]; then
            TODAY=$(date +"%d %B %Y")
            ID=$(date +%s)

            NEW_ITEM=$(jq -n \
              --arg id "$ID" \
              --arg j "Kesaksian $TODAY" \
              --arg i "Transformasi hidup terjadi melalui proses.\n\nTekanan membentuk karakter.\n\nKomitmen jangka panjang menghasilkan perubahan nyata." \
              '{id:$id, judul:$j, isi:$i}')

            if [ -f data/kesaksian.json ]; then
              jq ". |= [$NEW_ITEM] + . | .[:30]" data/kesaksian.json > temp.json
            else
              echo "[$NEW_ITEM]" > temp.json
            fi

            mv temp.json data/kesaksian.json
          fi

      - name: Update Lagu Harian
        run: |
          VIDEOS=("dy9nwe9_xzw" "iJCV_2H9xD0" "6X7bPj7V7mA" "0LwcvjNJnWA")
          INDEX=$(( $(date +%j) % 4 ))
          VIDEO_ID=${VIDEOS[$INDEX]}

          cat > data/lagu.json <<EOF
          {
            "judul": "Lagu Rohani Hari Ini",
            "video_id": "$VIDEO_ID"
          }
          EOF

      - name: Commit & Push
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add .
          git commit -m "Dynamic auto update content" || echo "No changes"
          git push
